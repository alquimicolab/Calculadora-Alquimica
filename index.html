<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora - Cotizador Vintage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Space+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --calc-beige: #d4c4a8;
            --calc-dark: #2a2520;
            --calc-gray: #8b8680;
            --display-bg: #9ea792;
            --display-text: #1a1a1a;
            --amber: #ff8c00;
            --amber-dark: #cc5500;
            --paper: #f5f5dc;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255,140,0,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(212,196,168,0.1) 0%, transparent 50%);
            min-height: 100vh;
        }
        
        .font-vintage {
            font-family: 'VT323', monospace;
        }
        
        .font-mono {
            font-family: 'Space Mono', monospace;
        }
        
        .calculator-body {
            background: linear-gradient(145deg, #e8dcc8 0%, #c9b896 100%);
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.2);
            border-radius: 20px;
            border: 3px solid #b8a888;
        }
        
        .calculator-display {
            background: var(--display-bg);
            border: 4px solid #7a7568;
            border-radius: 8px;
            box-shadow: 
                inset 0 3px 6px rgba(0,0,0,0.3),
                0 1px 2px rgba(255,255,255,0.2);
            font-family: 'VT323', monospace;
            color: var(--display-text);
            text-shadow: 0 0 2px rgba(0,0,0,0.2);
        }
        
        .vintage-btn {
            background: linear-gradient(145deg, #f0e6d3 0%, #d4c4a8 100%);
            border: 2px solid #a89878;
            border-bottom: 4px solid #8b7d68;
            border-radius: 8px;
            box-shadow: 
                0 4px 6px rgba(0,0,0,0.2),
                inset 0 1px 2px rgba(255,255,255,0.5);
            transition: all 0.1s;
            color: #2a2520;
            font-weight: 600;
        }
        
        .vintage-btn:active {
            transform: translateY(2px);
            border-bottom: 2px solid #8b7d68;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .vintage-btn.active {
            background: linear-gradient(145deg, #ff8c00 0%, #cc5500 100%);
            color: white;
            border-color: #994000;
            border-bottom: 4px solid #773000;
        }
        
        .vintage-btn.secondary {
            background: linear-gradient(145deg, #6b6558 0%, #4a4538 100%);
            color: #f0e6d3;
            border-color: #3a3528;
            border-bottom: 4px solid #2a2520;
        }
        
        .vintage-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        
        .vintage-panel {
            background: rgba(240, 230, 211, 0.05);
            border: 2px solid rgba(212, 196, 168, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .led-indicator {
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 4px #ff4444, inset 0 1px 2px rgba(0,0,0,0.3);
            display: inline-block;
            margin-right: 6px;
        }
        
        .led-indicator.on {
            background: #00ff44;
            box-shadow: 0 0 6px #00ff44, inset 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .solar-panel {
            background: linear-gradient(135deg, #2a1f1a 0%, #1a1510 100%);
            border-radius: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .retro-input {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(212, 196, 168, 0.4);
            color: #f0e6d3;
            font-family: 'Space Mono', monospace;
        }
        
        .retro-input:focus {
            border-color: #ff8c00;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,140,0,0.2);
        }
        
        .brand-text {
            font-family: 'VT323', monospace;
            letter-spacing: 2px;
            color: #8b7d68;
            text-transform: uppercase;
        }
        
        .paper-texture {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
        }
        
        /* TICKET POPUP ESTILOS */
        .ticket-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .ticket-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .ticket-modal {
            background: var(--paper);
            width: 100%;
            max-width: 450px;
            border-radius: 4px;
            box-shadow: 
                0 25px 50px -12px rgba(0,0,0,0.7),
                0 0 0 1px rgba(255,255,255,0.1),
                0 0 100px rgba(255,140,0,0.2);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        
        .ticket-overlay.active .ticket-modal {
            transform: scale(1) translateY(0);
        }
        
        .ticket-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff8c00, #ff6b00, #ff8c00);
        }
        
        .ticket-header {
            background: linear-gradient(145deg, #2a2520 0%, #1a1510 100%);
            color: var(--calc-beige);
            padding: 20px;
            text-align: center;
            border-bottom: 3px dashed rgba(255,140,0,0.3);
        }
        
        .ticket-perforation {
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 20px;
            background: radial-gradient(circle at 50% 0, transparent 8px, var(--paper) 8px);
            background-size: 20px 20px;
            background-repeat: repeat-x;
        }
        
        .ticket-content {
            padding: 25px;
            font-family: 'Space Mono', monospace;
            color: #2a2520;
        }
        
        .ticket-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .ticket-row.total {
            border-top: 2px solid #2a2520;
            border-bottom: 2px solid #2a2520;
            padding: 15px 0;
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .ticket-stamp {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: rotate(-15deg) translateY(-50%);
            border: 3px solid #ff4444;
            color: #ff4444;
            padding: 10px 20px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 3px;
            opacity: 0.8;
            pointer-events: none;
        }
        
        .close-x {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--calc-beige);
            transition: all 0.2s;
            z-index: 10;
        }
        
        .close-x:hover {
            background: #ff4444;
            color: white;
            transform: rotate(90deg);
        }
        
        .sending-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            flex-direction: column;
        }
        
        .sending-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--calc-beige);
            border-top-color: var(--amber);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .min-qty-warning {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff8888;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }
        
        .min-qty-warning.show {
            display: block;
        }
        
        .pulse-ring {
            position: absolute;
            inset: -10px;
            border: 2px solid rgba(255,140,0,0.5);
            border-radius: 8px;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            pointer-events: none;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0; }
        }
        
        /* Estilos para upload de archivos nativo */
        .file-upload-area {
            border: 3px dashed rgba(255, 140, 0, 0.4);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-area:hover {
            border-color: rgba(255, 140, 0, 0.8);
            background: rgba(255, 140, 0, 0.05);
            transform: translateY(-2px);
        }
        
        .file-upload-area:active {
            transform: translateY(0);
        }
        
        .file-upload-area.has-files {
            border-color: #00ff44;
            background: rgba(0, 255, 68, 0.05);
        }
        
        .file-upload-area.uploading {
            border-color: #ff8c00;
            background: rgba(255, 140, 0, 0.1);
            pointer-events: none;
        }
        
        .file-input-hidden {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        
        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            font-family: 'Space Mono', monospace;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .file-item.success {
            border-left-color: #00ff44;
            background: rgba(0, 255, 68, 0.1);
        }
        
        .file-item.uploading {
            border-left-color: #ff8c00;
            background: rgba(255, 140, 0, 0.1);
        }
        
        .file-item.error {
            border-left-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff8c00, #ff6b00);
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        
        .remove-file {
            color: #ff4444;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-file:hover {
            background: rgba(255,68,68,0.2);
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: #ff8c00;
            transition: transform 0.3s ease;
        }
        
        .file-upload-area:hover .upload-icon {
            transform: scale(1.1);
        }
        
        .file-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }
        
        .file-name {
            font-weight: 600;
            color: #f0e6d3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-meta {
            font-size: 11px;
            color: #8b8680;
            margin-top: 2px;
        }
        
        .file-status {
            font-size: 11px;
            margin-top: 4px;
        }
        
        .file-status.success { color: #00ff44; }
        .file-status.uploading { color: #ff8c00; }
        .file-status.error { color: #ff4444; }
        
        .add-more-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: rgba(255, 140, 0, 0.2);
            border: 2px dashed rgba(255, 140, 0, 0.5);
            border-radius: 8px;
            color: #ff8c00;
            font-family: 'VT323', monospace;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-more-btn:hover {
            background: rgba(255, 140, 0, 0.3);
            border-color: rgba(255, 140, 0, 0.8);
        }
        
        @keyframes upload-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 140, 0, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 140, 0, 0); }
        }
        
        .file-upload-area.pulse {
            animation: upload-pulse 2s infinite;
        }
    </style>
</head>
<body class="paper-texture p-4 md:p-8">

    <!-- Overlay de envío -->
    <div id="sendingOverlay" class="sending-overlay">
        <div class="spinner mb-4"></div>
        <div class="font-vintage text-2xl text-amber-500 mb-2">TRANSMITIENDO...</div>
        <div class="text-gray-400 text-sm font-mono" id="sendingStatus">Preparando cotización...</div>
        <div class="text-gray-500 text-xs mt-4 font-mono">xsiempreverdex@gmail.com</div>
    </div>

    <!-- TICKET POPUP PRINCIPAL -->
    <div id="ticketPopup" class="ticket-overlay" onclick="closeTicketIfOutside(event)">
        <div class="ticket-modal" onclick="event.stopPropagation()">
            <div class="pulse-ring"></div>
            
            <div class="close-x" onclick="closeTicketPopup()">
                <i data-lucide="x" class="w-5 h-5"></i>
            </div>
            
            <div class="ticket-header">
                <div class="font-vintage text-3xl text-amber-500 mb-1">CALCULADORA</div>
                <div class="text-xs tracking-widest opacity-80">AlquímicoLab.</div>
                <div class="mt-3 inline-block bg-amber-600 text-black px-3 py-1 rounded font-mono text-sm font-bold" id="ticketRef">
                    CG-000000
                </div>
            </div>
            
            <div class="ticket-stamp" id="ticketStamp">PENDIENTE</div>
            
            <div class="ticket-content">
                <div class="mb-4 pb-4 border-b-2 border-dashed border-gray-400">
                    <div class="text-xs text-gray-500 mb-1">FECHA Y HORA</div>
                    <div class="font-bold" id="ticketDate">--/--/---- --:--</div>
                </div>
                
                <div class="mb-4">
                    <div class="text-xs text-gray-500 mb-2">DATOS DEL CLIENTE</div>
                    <div class="font-bold text-lg mb-1" id="ticketClient">---</div>
                    <div class="text-sm text-gray-600" id="ticketContact">---</div>
                </div>
                
                <div class="mb-4">
                    <div class="text-xs text-gray-500 mb-2">DETALLE DE LA ORDEN</div>
                    <div id="ticketDetails">
                        <!-- Generado dinámicamente -->
                    </div>
                </div>
                
                <!-- Sección de archivos en el ticket -->
                <div class="mb-4 p-3 bg-gray-100 rounded border border-gray-300" id="ticketFiles" style="display: none;">
                    <div class="text-xs text-gray-500 mb-2 font-bold">ARCHIVOS ADJUNTOS:</div>
                    <div id="ticketFilesList" class="text-xs space-y-1"></div>
                </div>
                
                <div class="ticket-row total">
                    <span>TOTAL A PAGAR</span>
                    <span id="ticketTotal">$0.00</span>
                </div>
                
                <div class="mt-4 text-center">
                    <div class="inline-block bg-gray-200 px-3 py-1 rounded text-xs font-bold text-gray-700" id="ticketDelivery">
                        ENTREGA: 5-7 DÍAS
                    </div>
                </div>
                
                <div class="mt-4 text-center text-xs text-gray-500">
                    Válido por 15 días • Precios sujetos a cambio sin previo aviso
                </div>
            </div>
            
            <div class="ticket-perforation"></div>
            
            <!-- Acciones del ticket -->
            <div class="p-4 bg-gray-100 border-t border-gray-300 flex gap-2">
                <button onclick="printTicket()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-3 rounded font-mono font-bold transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    IMPRIMIR
                </button>
                <button onclick="closeTicketPopup()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded font-mono font-bold transition-colors">
                    CERRAR
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Header Vintage -->
        <div class="text-center mb-8">
            <div class="inline-block calculator-body px-8 py-4 mb-4">
                <h1 class="font-vintage text-5xl md:text-6xl text-amber-600 drop-shadow-lg" style="text-shadow: 2px 2px 0px rgba(0,0,0,0.3);">CALCULADORA</h1>
                <div class="flex justify-between items-center mt-2">
                    <span class="brand-text text-sm">AlquímicoLab.</span>
                    <div class="solar-panel w-24 h-6 flex gap-1 p-1">
                        <div class="flex-1 bg-amber-900/50"></div>
                        <div class="flex-1 bg-amber-900/50"></div>
                        <div class="flex-1 bg-amber-900/50"></div>
                    </div>
                </div>
            </div>
            <p class="text-gray-400 font-mono text-sm">Sistema de Cotización • Mínimo 12 piezas • Máximo 250</p>
        </div>

        <div class="grid lg:grid-cols-12 gap-6">
            
            <!-- Panel Principal -->
            <div class="lg:col-span-7 space-y-4">
                
                <!-- Datos del Cliente -->
                <div class="vintage-panel p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="led-indicator on"></span>
                        <h2 class="font-vintage text-2xl text-amber-500">DATOS DEL CLIENTE</h2>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-400 font-mono text-xs mb-2 uppercase tracking-wider">Nombre / Empresa *</label>
                            <input type="text" id="clientName" placeholder="Ingrese nombre del cliente..." 
                                   class="retro-input w-full px-4 py-3 rounded-lg text-lg"
                                   onchange="updateClient()">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-400 font-mono text-xs mb-2 uppercase tracking-wider">Teléfono *</label>
                                <input type="tel" id="clientPhone" placeholder="555-0000" 
                                       class="retro-input w-full px-4 py-2 rounded text-sm"
                                       onchange="validateForm()">
                            </div>
                            <div>
                                <label class="block text-gray-400 font-mono text-xs mb-2 uppercase tracking-wider">Email *</label>
                                <input type="email" id="clientEmail" placeholder="cliente@email.com" 
                                       class="retro-input w-full px-4 py-2 rounded text-sm"
                                       onchange="validateForm()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subida de Archivos NATIVO -->
                <div class="vintage-panel p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="led-indicator" id="led-files"></span>
                        <h2 class="font-vintage text-2xl text-amber-500">05. ARCHIVOS DE DISEÑO</h2>
                    </div>
                    
                    <div class="space-y-3">
                        <!-- TEXTO ACTUALIZADO: 25MB en lugar de 10MB -->
                        <div class="text-xs text-gray-400 font-mono mb-2 flex justify-between">
                            <span>Formatos: PDF, PSD, AI (Máx 25MB c/u)</span>
                            <span id="fileCounter" style="display: none;">0/5 archivos</span>
                        </div>
                        
                        <!-- Área de upload con input nativo -->
                        <div id="uploadArea" class="file-upload-area pulse" onclick="triggerFileInput()">
                            <input 
                                type="file" 
                                id="fileInput" 
                                class="file-input-hidden"
                                accept=".pdf,.psd,.ai,.PDF,.PSD,.AI"
                                multiple
                                onchange="handleFileSelect(event)"
                            >
                            
                            <div class="text-center pointer-events-none">
                                <div class="upload-icon">
                                    <i data-lucide="folder-open" class="w-full h-full"></i>
                                </div>
                                <div class="font-vintage text-xl text-amber-500 mb-2">CLICK PARA ABRIR ARCHIVOS</div>
                                <div class="text-xs text-gray-500 font-mono mb-1">Se abrirá tu explorador de archivos</div>
                                <div class="text-[10px] text-gray-600">Windows: Explorador | Mac: Finder | Móvil: Galería/Archivos</div>
                            </div>
                        </div>
                        
                        <!-- Lista de archivos -->
                        <div id="fileList" class="file-list" style="display: none;"></div>
                        
                        <!-- Botón agregar más -->
                        <button id="addMoreBtn" onclick="triggerFileInput()" class="add-more-btn" style="display: none;">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            AGREGAR MÁS ARCHIVOS
                        </button>
                    </div>
                </div>

                <!-- Tipo de Prenda -->
                <div class="vintage-panel p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="led-indicator" id="led-shirt"></span>
                        <h2 class="font-vintage text-2xl text-amber-500">01. TIPO DE PRENDA</h2>
                    </div>
                    <div class="grid grid-cols-3 gap-3" id="shirtTypes">
                        <!-- Generado por JS -->
                    </div>
                </div>

                <!-- Cantidad (12-250) -->
                <div class="vintage-panel p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="led-indicator" id="led-qty"></span>
                        <h2 class="font-vintage text-2xl text-amber-500">02. CANTIDAD</h2>
                    </div>
                    <div class="calculator-body p-4">
                        <div class="flex items-center gap-4">
                            <button class="vintage-btn secondary w-12 h-12 text-xl" onclick="adjustQty(-12)">−12</button>
                            <button class="vintage-btn secondary w-12 h-12 text-xl" onclick="adjustQty(-1)">−</button>
                            <input type="number" id="quantity" value="24" min="12" max="250" 
                                   class="calculator-display flex-1 text-center text-4xl py-2 font-vintage"
                                   onchange="validateAndUpdateQuantity(this.value)">
                            <button class="vintage-btn secondary w-12 h-12 text-xl" onclick="adjustQty(1)">+</button>
                            <button class="vintage-btn secondary w-12 h-12 text-xl" onclick="adjustQty(12)">+12</button>
                        </div>
                        <input type="range" id="quantityRange" min="12" max="250" value="24" step="1"
                               class="w-full mt-4 accent-amber-600"
                               oninput="updateQuantity(this.value)">
                        <div class="flex justify-between text-xs text-gray-500 font-mono mt-1">
                            <span>12 mín</span>
                            <span>131</span>
                            <span>250 máx</span>
                        </div>
                        <div id="minQtyWarning" class="min-qty-warning font-mono text-center">
                            ⚠ MÍNIMO 12 PIEZAS PARA COTIZAR
                        </div>
                    </div>
                    <div id="volumeBadge" class="mt-4 hidden">
                        <div class="calculator-display inline-block px-4 py-2 text-amber-700 font-bold">
                            DESCUENTO: <span id="discountPercent">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Posiciones de Impresión -->
                <div class="vintage-panel p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="led-indicator" id="led-pos"></span>
                        <h2 class="font-vintage text-2xl text-amber-500">03. POSICIONES</h2>
                    </div>
                    <div class="space-y-3" id="positionsContainer">
                        <!-- Generado por JS -->
                    </div>
                </div>

                <!-- Extras -->
                <div class="vintage-panel p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="led-indicator" id="led-extras"></span>
                        <h2 class="font-vintage text-2xl text-amber-500">04. EXTRAS</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-3" id="extras">
                        <!-- Generado por JS -->
                    </div>
                </div>
            </div>

            <!-- Panel de Totales (Calculadora) -->
            <div class="lg:col-span-5">
                <div class="sticky top-4">
                    <div class="calculator-body p-6">
                        <!-- Display Principal -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="brand-text text-xs">TOTAL</span>
                                <div class="flex gap-1">
                                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                                    <div class="w-2 h-2 rounded-full bg-amber-500 animate-pulse delay-75"></div>
                                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse delay-150"></div>
                                </div>
                            </div>
                            <div class="calculator-display p-4 text-right">
                                <div class="text-sm text-gray-600 font-mono mb-1" id="clientDisplay">CLIENTE: ---</div>
                                <div class="text-5xl font-vintage tracking-wider" id="totalDisplay">$0.00</div>
                                <div class="text-sm text-gray-600 font-mono mt-1" id="unitDisplay">$0.00 / unidad</div>
                            </div>
                        </div>

                        <!-- Desglose -->
                        <div class="bg-black/20 rounded-lg p-4 mb-6 font-mono text-sm space-y-2" id="breakdown">
                            <!-- Generado dinámicamente -->
                        </div>

                        <!-- Teclado de Acciones -->
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="resetForm()" class="vintage-btn secondary py-4 font-vintage text-lg tracking-wider">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                                CE
                            </button>
                            <button id="printBtn" onclick="generateAndShowTicket()" class="vintage-btn active py-4 font-vintage text-lg tracking-wider" disabled>
                                <i data-lucide="ticket" class="w-4 h-4 inline mr-2"></i>
                                GENERAR
                            </button>
                            <button onclick="shareQuote()" class="vintage-btn py-3 font-vintage col-span-2">
                                <i data-lucide="share-2" class="w-4 h-4 inline mr-2"></i>
                                COMPARTIR COTIZACIÓN
                            </button>
                        </div>

                        <!-- Indicador de envío automático -->
                        <div class="mt-4 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                            <div class="flex items-center gap-2 text-amber-600 text-xs font-mono">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                                <span>Al generar se envía a:</span>
                            </div>
                            <div class="text-amber-500 font-mono text-xs mt-1 truncate">
                                xsiempreverdex@gmail.com
                            </div>
                        </div>

                        <!-- Cinta de impresión visual -->
                        <div class="mt-4 bg-white/10 rounded p-3 font-mono text-xs text-gray-400 h-32 overflow-y-auto" id="receiptPreview">
                            <div class="text-center border-b border-gray-600 pb-2 mb-2">
                                <div class="font-vintage text-lg text-amber-500">CALCULADORA</div>
                                <div>COTIZACIÓN PRELIMINAR</div>
                            </div>
                            <div id="receiptContent">
                                Esperando datos...
                            </div>
                        </div>
                    </div>

                    <!-- Info de entrega -->
                    <div class="mt-4 vintage-panel p-4 border-l-4 border-amber-600">
                        <div class="flex items-center gap-2 text-amber-500 font-vintage text-lg mb-1">
                            <i data-lucide="clock" class="w-5 h-5"></i>
                            TIEMPO DE ENTREGA
                        </div>
                        <div class="text-gray-300 font-mono" id="deliveryTime">5-7 días hábiles</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Cloudinary
        const CLOUDINARY_CONFIG = {
            cloudName: 'dpss4ae6f',
            uploadPreset: 'calculadora_uploads',
            folder: 'calculadora'
        };

        // CONSTANTE ACTUALIZADA: 25MB en lugar de 10MB
        const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25MB en bytes

        // Inicializar EmailJS
        (function() {
            emailjs.init("Wu2u-wQ48NHmxo1rR");
        })();

        lucide.createIcons();

        const config = {
            shirtTypes: [
                { id: 'basic', name: 'BÁSICA', price: 45, desc: 'Alg. 150-160g' },
                { id: 'premium', name: 'PREMIUM', price: 55, desc: 'Alg. peinado 180g' },
                { id: 'heavy', name: 'HEAVY WT', price: 66, desc: '200g/m²' }
            ],
            printPrices: {
                chest: {
                    name: '5x5"',
                    prices: [0, 15, 25, 35, 45, 55, 65]
                },
                full: {
                    name: 'FULL SIZE',
                    prices: [0, 50, 85, 100, 125, 145, 160]
                }
            },
            positions: [
                { id: 'front', name: 'FRENTE', type: 'full', default: false },
                { id: 'back', name: 'ESPALDA', type: 'full', default: false },
                { id: 'leftChest', name: 'PECHO IZQ', type: 'chest', default: false },
                { id: 'rightChest', name: 'PECHO DER', type: 'chest', default: false },
                { id: 'leftSleeve', name: 'MANGA IZQ', type: 'chest', default: false },
                { id: 'rightSleeve', name: 'MANGA DER', type: 'chest', default: false }
            ],
            extras: [
                { id: 'design', name: 'DISEÑO', price: 350, desc: 'Arte original' },
                { id: 'urgent', name: 'EXPRESS', price: 0.25, desc: '+25%', isPercentage: true },
                { id: 'packaging', name: 'EMPAQUE', price: 8, desc: 'Individual' },
                { id: 'label', name: 'ETIQUETA', price: 12, desc: 'Interior' }
            ],
            volumeDiscounts: [
                { min: 12, max: 23, discount: 0 },
                { min: 24, max: 49, discount: 0.10 },
                { min: 50, max: 99, discount: 0.15 },
                { min: 100, max: 149, discount: 0.20 },
                { min: 150, max: 199, discount: 0.25 },
                { min: 200, max: 250, discount: 0.30 }
            ]
        };

        let state = {
            client: '',
            phone: '',
            email: '',
            shirtType: 'basic',
            quantity: 24,
            positions: {
                front: { active: false, colors: 2 },
                back: { active: false, colors: 1 },
                leftChest: { active: false, colors: 1 },
                rightChest: { active: false, colors: 1 },
                leftSleeve: { active: false, colors: 1 },
                rightSleeve: { active: false, colors: 1 }
            },
            extras: [],
            uploadedFiles: []
        };

        // ========== FUNCIONES DE UPLOAD DE ARCHIVOS ==========

        function triggerFileInput() {
            if (state.uploadedFiles.length >= 5) {
                alert('Máximo 5 archivos permitidos');
                return;
            }
            
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;
            
            const totalFiles = state.uploadedFiles.length + files.length;
            if (totalFiles > 5) {
                alert(`Solo puedes subir 5 archivos total. Ya tienes ${state.uploadedFiles.length}.`);
                return;
            }
            
            files.forEach(file => {
                const validExtensions = ['.pdf', '.psd', '.ai'];
                const fileName = file.name.toLowerCase();
                const isValid = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isValid) {
                    alert(`"${file.name}" no es un formato válido. Solo se permiten: PDF, PSD, AI`);
                    return;
                }
                
                // VALIDACIÓN ACTUALIZADA: Usa MAX_FILE_SIZE (25MB)
                if (file.size > MAX_FILE_SIZE) {
                    alert(`"${file.name}" excede el límite de 25MB`);
                    return;
                }
                
                const tempFile = {
                    id: 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    file: file,
                    name: file.name,
                    // Cálculo de tamaño actualizado para mostrar MB o KB según corresponda
                    size: file.size > 1024 * 1024 
                        ? (file.size / 1024 / 1024).toFixed(2) + ' MB' 
                        : (file.size / 1024).toFixed(2) + ' KB',
                    format: file.name.split('.').pop().toLowerCase(),
                    status: 'pending',
                    progress: 0,
                    url: null
                };
                
                state.uploadedFiles.push(tempFile);
            });
            
            event.target.value = '';
            
            updateFileList();
            uploadPendingFiles();
        }

        async function uploadPendingFiles() {
            const pendingFiles = state.uploadedFiles.filter(f => f.status === 'pending');
            
            if (pendingFiles.length === 0) return;
            
            document.getElementById('uploadArea').classList.add('uploading');
            
            for (const fileData of pendingFiles) {
                await uploadFileToCloudinary(fileData);
            }
            
            document.getElementById('uploadArea').classList.remove('uploading');
            validateForm();
        }

        async function uploadFileToCloudinary(fileData) {
            fileData.status = 'uploading';
            updateFileList();
            
            const formData = new FormData();
            formData.append('file', fileData.file);
            formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
            formData.append('folder', CLOUDINARY_CONFIG.folder);
            formData.append('public_id', `calculadora_${Date.now()}_${fileData.id}`);
            
            try {
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/auto/upload`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                fileData.status = 'success';
                fileData.url = result.secure_url;
                fileData.publicId = result.public_id;
                fileData.thumbnail = result.thumbnail_url || result.secure_url;
                
                console.log('Archivo subido:', fileData.name, fileData.url);
                
            } catch (error) {
                console.error('Error subiendo archivo:', error);
                fileData.status = 'error';
                fileData.errorMessage = error.message;
            }
            
            updateFileList();
        }

        function updateFileList() {
            const listContainer = document.getElementById('fileList');
            const uploadArea = document.getElementById('uploadArea');
            const addMoreBtn = document.getElementById('addMoreBtn');
            const fileCounter = document.getElementById('fileCounter');
            
            const hasFiles = state.uploadedFiles.length > 0;
            const allSuccess = state.uploadedFiles.every(f => f.status === 'success');
            
            fileCounter.style.display = hasFiles ? 'block' : 'none';
            fileCounter.textContent = `${state.uploadedFiles.length}/5 archivos`;
            
            document.getElementById('led-files').className = hasFiles ? 'led-indicator on' : 'led-indicator';
            
            if (!hasFiles) {
                listContainer.style.display = 'none';
                addMoreBtn.style.display = 'none';
                uploadArea.classList.remove('has-files');
                uploadArea.style.display = 'block';
                return;
            }
            
            listContainer.style.display = 'block';
            addMoreBtn.style.display = state.uploadedFiles.length < 5 ? 'inline-flex' : 'none';
            uploadArea.classList.toggle('has-files', allSuccess);
            
            listContainer.innerHTML = state.uploadedFiles.map((file, index) => {
                let statusIcon, statusText, statusClass;
                
                switch(file.status) {
                    case 'uploading':
                        statusIcon = 'loader-2';
                        statusText = `Subiendo... ${file.progress}%`;
                        statusClass = 'uploading';
                        break;
                    case 'success':
                        statusIcon = 'check-circle';
                        statusText = 'Subido';
                        statusClass = 'success';
                        break;
                    case 'error':
                        statusIcon = 'alert-circle';
                        statusText = 'Error';
                        statusClass = 'error';
                        break;
                    default:
                        statusIcon = 'clock';
                        statusText = 'Pendiente';
                        statusClass = '';
                }
                
                return `
                    <div class="file-item ${statusClass}">
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">${file.format.toUpperCase()} • ${file.size}</div>
                            ${file.status === 'uploading' ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${file.progress}%"></div>
                                </div>
                            ` : ''}
                            <div class="file-status ${file.status}">
                                <i data-lucide="${statusIcon}" class="w-3 h-3 inline mr-1"></i>
                                ${statusText}
                            </div>
                        </div>
                        ${file.status !== 'uploading' ? `
                            <button onclick="removeFile(${index})" class="remove-file" title="Eliminar">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        ` : '<div class="w-8"></div>'}
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
            updateReceipt();
        }

        function removeFile(index) {
            state.uploadedFiles.splice(index, 1);
            updateFileList();
            validateForm();
        }

        // ========== RESTO DE FUNCIONES ==========

        function init() {
            renderShirtTypes();
            renderPositions();
            renderExtras();
            updateClient();
            validateForm();
            calculate();
        }

        function renderShirtTypes() {
            const container = document.getElementById('shirtTypes');
            container.innerHTML = config.shirtTypes.map(type => `
                <button class="vintage-btn ${state.shirtType === type.id ? 'active' : ''} p-3 text-center" 
                        onclick="selectShirtType('${type.id}')">
                    <div class="font-vintage text-xl mb-1">${type.name}</div>
                    <div class="text-xs text-gray-600 font-mono">$${type.price}</div>
                    <div class="text-[10px] text-gray-500">${type.desc}</div>
                </button>
            `).join('');
        }

        function renderPositions() {
            const container = document.getElementById('positionsContainer');
            container.innerHTML = config.positions.map(pos => {
                const posState = state.positions[pos.id];
                const priceTable = config.printPrices[pos.type];
                
                return `
                <div class="calculator-body p-3 ${posState.active ? 'ring-2 ring-amber-600' : ''}">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" ${posState.active ? 'checked' : ''} 
                                   onchange="togglePosition('${pos.id}')"
                                   class="w-4 h-4 accent-amber-600">
                            <span class="font-vintage text-lg text-gray-800">${pos.name}</span>
                        </div>
                        ${posState.active ? `
                            <span class="calculator-display px-2 py-1 text-sm font-vintage" id="price-${pos.id}">
                                $${priceTable.prices[posState.colors]}
                            </span>
                        ` : '<span class="text-gray-400 text-xs">OFF</span>'}
                    </div>
                    
                    ${posState.active ? `
                        <div class="flex gap-1 justify-center">
                            ${[1,2,3,4,5,6].map(num => `
                                <button onclick="setPositionColors('${pos.id}', ${num})" 
                                        class="w-8 h-8 rounded font-vintage text-sm border-2 
                                               ${posState.colors === num ? 'bg-amber-600 text-white border-amber-800' : 'bg-gray-200 border-gray-400 hover:bg-gray-300'}">
                                    ${num}
                                </button>
                            `).join('')}
                        </div>
                        <div class="text-center text-xs text-gray-500 mt-1 font-mono">
                            ${priceTable.name} • ${posState.colors} TINTA${posState.colors > 1 ? 'S' : ''}
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function renderExtras() {
            const container = document.getElementById('extras');
            container.innerHTML = config.extras.map(extra => `
                <button class="vintage-btn ${state.extras.includes(extra.id) ? 'active' : ''} p-3 text-left w-full"
                        onclick="toggleExtra('${extra.id}')">
                    <div class="flex justify-between items-center">
                        <span class="font-vintage text-lg">${extra.name}</span>
                        <span class="text-amber-700 font-bold font-mono">
                            ${extra.isPercentage ? '+' + (extra.price * 100) + '%' : '$' + extra.price}
                        </span>
                    </div>
                    <div class="text-xs text-gray-600">${extra.desc}</div>
                </button>
            `).join('');
        }

        function validateForm() {
            const name = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const qty = parseInt(document.getElementById('quantity').value) || 0;
            
            const isValid = name && phone && email && qty >= 12 && qty <= 250;
            
            const btn = document.getElementById('printBtn');
            btn.disabled = !isValid;
            
            if (isValid) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            return isValid;
        }

        function validateAndUpdateQuantity(val) {
            const num = parseInt(val) || 12;
            const clamped = Math.max(12, Math.min(250, num));
            
            if (num < 12) {
                document.getElementById('minQtyWarning').classList.add('show');
            } else {
                document.getElementById('minQtyWarning').classList.remove('show');
            }
            
            updateQuantity(clamped);
        }

        function updateClient() {
            const name = document.getElementById('clientName').value || '---';
            state.client = name;
            document.getElementById('clientDisplay').textContent = 'CLIENTE: ' + name.substring(0, 20);
            validateForm();
            updateReceipt();
        }

        function selectShirtType(id) {
            state.shirtType = id;
            renderShirtTypes();
            calculate();
        }

        function togglePosition(id) {
            state.positions[id].active = !state.positions[id].active;
            renderPositions();
            calculate();
        }

        function setPositionColors(posId, colors) {
            state.positions[posId].colors = colors;
            renderPositions();
            calculate();
        }

        function toggleExtra(id) {
            if (state.extras.includes(id)) {
                state.extras = state.extras.filter(e => e !== id);
            } else {
                state.extras.push(id);
            }
            renderExtras();
            calculate();
        }

        function adjustQty(delta) {
            const newQty = Math.max(12, Math.min(250, state.quantity + delta));
            updateQuantity(newQty);
        }

        function updateQuantity(val) {
            state.quantity = parseInt(val) || 12;
            document.getElementById('quantity').value = state.quantity;
            document.getElementById('quantityRange').value = state.quantity;
            
            if (state.quantity >= 12) {
                document.getElementById('minQtyWarning').classList.remove('show');
            }
            
            validateForm();
            calculate();
        }

        function calculate() {
            const shirt = config.shirtTypes.find(s => s.id === state.shirtType);
            
            let printCostPerUnit = 0;
            let positionDetails = [];
            
            Object.entries(state.positions).forEach(([posId, posState]) => {
                if (posState.active) {
                    const posConfig = config.positions.find(p => p.id === posId);
                    const priceTable = config.printPrices[posConfig.type];
                    const cost = priceTable.prices[posState.colors];
                    printCostPerUnit += cost;
                    
                    positionDetails.push({
                        name: posConfig.name,
                        colors: posState.colors,
                        cost: cost,
                        size: priceTable.name
                    });
                    
                    const priceEl = document.getElementById(`price-${posId}`);
                    if (priceEl) priceEl.textContent = '$' + cost;
                }
            });
            
            let unitPrice = shirt.price + printCostPerUnit;
            
            const discount = config.volumeDiscounts.find(d => state.quantity >= d.min && state.quantity <= d.max);
            const discountRate = discount ? discount.discount : 0;
            
            let subtotal = unitPrice * state.quantity;
            let discountAmount = subtotal * discountRate;
            let total = subtotal - discountAmount;
            
            let extrasCost = 0;
            state.extras.forEach(extraId => {
                const extra = config.extras.find(e => e.id === extraId);
                if (extra && !extra.isPercentage) {
                    extrasCost += extra.price * state.quantity;
                }
            });
            
            total += extrasCost;
            
            state.extras.forEach(extraId => {
                const extra = config.extras.find(e => e.id === extraId);
                if (extra && extra.isPercentage) {
                    total *= (1 + extra.price);
                }
            });
            
            updateUI({
                shirt,
                unitPrice,
                subtotal,
                discountAmount,
                discountRate,
                total,
                positionDetails,
                extrasCost
            });
        }

        function updateUI(data) {
            document.getElementById('totalDisplay').textContent = '$' + data.total.toFixed(2);
            document.getElementById('unitDisplay').textContent = '$' + data.unitPrice.toFixed(2) + ' / unidad';
            
            const badge = document.getElementById('volumeBadge');
            if (data.discountRate > 0) {
                badge.classList.remove('hidden');
                document.getElementById('discountPercent').textContent = (data.discountRate * 100).toFixed(0) + '%';
            } else {
                badge.classList.add('hidden');
            }
            
            let html = `
                <div class="flex justify-between text-gray-400 border-b border-gray-700 pb-1">
                    <span>${data.shirt.name} x${state.quantity}</span>
                    <span>$${(data.shirt.price * state.quantity).toFixed(2)}</span>
                </div>
            `;
            
            data.positionDetails.forEach(pos => {
                html += `
                    <div class="flex justify-between text-gray-500 text-xs ml-2">
                        <span>└ ${pos.name} (${pos.size}, ${pos.colors}T)</span>
                        <span>$${(pos.cost * state.quantity).toFixed(2)}</span>
                    </div>
                `;
            });
            
            if (data.discountAmount > 0) {
                html += `
                    <div class="flex justify-between text-amber-500 text-sm border-t border-gray-700 pt-1">
                        <span>DTO. VOLUMEN</span>
                        <span>-$${data.discountAmount.toFixed(2)}</span>
                    </div>
                `;
            }
            
            if (data.extrasCost > 0) {
                html += `
                    <div class="flex justify-between text-gray-400 text-sm">
                        <span>EXTRAS</span>
                        <span>$${data.extrasCost.toFixed(2)}</span>
                    </div>
                `;
            }
            
            document.getElementById('breakdown').innerHTML = html;
            
            document.getElementById('led-shirt').className = 'led-indicator on';
            document.getElementById('led-qty').className = state.quantity >= 12 ? 'led-indicator on' : 'led-indicator';
            document.getElementById('led-pos').className = data.positionDetails.length > 0 ? 'led-indicator on' : 'led-indicator';
            document.getElementById('led-extras').className = state.extras.length > 0 ? 'led-indicator on' : 'led-indicator';
            
            updateReceipt();
            updateDeliveryTime();
        }

        function updateReceipt() {
            const shirt = config.shirtTypes.find(s => s.id === state.shirtType);
            const total = document.getElementById('totalDisplay').textContent;
            
            let posText = Object.entries(state.positions)
                .filter(([_, p]) => p.active)
                .map(([id, p]) => {
                    const name = config.positions.find(pos => pos.id === id).name;
                    return `${name}:${p.colors}T`;
                }).join(', ');
            
            let filesText = state.uploadedFiles.length > 0 
                ? `ARCHIVOS: ${state.uploadedFiles.filter(f => f.status === 'success').length}/${state.uploadedFiles.length}` 
                : 'SIN ARCHIVOS';
            
            document.getElementById('receiptContent').innerHTML = `
                <div class="font-mono text-xs leading-tight">
                    <div>CLIENTE: ${state.client || '---'}</div>
                    <div>PRENDA: ${shirt.name}</div>
                    <div>CANT: ${state.quantity} UND</div>
                    <div>POS: ${posText || 'NINGUNA'}</div>
                    <div class="text-amber-500">${filesText}</div>
                    <div class="border-t border-dashed border-gray-400 my-2"></div>
                    <div class="text-lg font-bold text-right">${total}</div>
                </div>
            `;
        }

        function updateDeliveryTime() {
            const hasUrgent = state.extras.includes('urgent');
            const el = document.getElementById('deliveryTime');
            if (hasUrgent) {
                el.textContent = '48-72 HORAS (EXPRESS)';
                el.className = 'text-amber-500 font-bold font-vintage';
            } else {
                el.textContent = '5-7 DÍAS HÁBILES';
                el.className = 'text-gray-300 font-mono';
            }
        }

        async function generateAndShowTicket() {
            if (!validateForm()) return;
            
            const uploadingFiles = state.uploadedFiles.filter(f => f.status === 'uploading');
            if (uploadingFiles.length > 0) {
                alert('Espera a que terminen de subir los archivos...');
                return;
            }
            
            const ref = 'CG-' + Date.now().toString().slice(-6);
            const shirt = config.shirtTypes.find(s => s.id === state.shirtType);
            const total = document.getElementById('totalDisplay').textContent;
            
            document.getElementById('ticketRef').textContent = ref;
            document.getElementById('ticketDate').textContent = new Date().toLocaleString('es-MX');
            document.getElementById('ticketClient').textContent = state.client;
            document.getElementById('ticketContact').textContent = 
                document.getElementById('clientPhone').value + ' | ' + document.getElementById('clientEmail').value;
            document.getElementById('ticketTotal').textContent = total;
            document.getElementById('ticketDelivery').textContent = 'ENTREGA: ' + document.getElementById('deliveryTime').textContent;
            
            let detailsHTML = `
                <div class="ticket-row">
                    <span class="text-gray-600">${shirt.name} x${state.quantity}</span>
                    <span class="font-bold">$${(shirt.price * state.quantity).toFixed(2)}</span>
                </div>
            `;
            
            Object.entries(state.positions).forEach(([posId, posState]) => {
                if (posState.active) {
                    const posConfig = config.positions.find(p => p.id === posId);
                    const priceTable = config.printPrices[posConfig.type];
                    const cost = priceTable.prices[posState.colors];
                    
                    detailsHTML += `
                        <div class="ticket-row text-sm">
                            <span class="text-gray-600">└ ${posConfig.name} (${priceTable.name}, ${posState.colors}T)</span>
                            <span>$${(cost * state.quantity).toFixed(2)}</span>
                        </div>
                    `;
                }
            });
            
            state.extras.forEach(extraId => {
                const extra = config.extras.find(e => e.id === extraId);
                if (!extra.isPercentage) {
                    detailsHTML += `
                        <div class="ticket-row text-sm">
                            <span class="text-gray-600">${extra.name}</span>
                            <span>$${(extra.price * state.quantity).toFixed(2)}</span>
                        </div>
                    `;
                }
            });
            
            document.getElementById('ticketDetails').innerHTML = detailsHTML;
            
            const filesSection = document.getElementById('ticketFiles');
            const filesList = document.getElementById('ticketFilesList');
            
            const successfulFiles = state.uploadedFiles.filter(f => f.status === 'success');
            
            if (successfulFiles.length > 0) {
                filesSection.style.display = 'block';
                filesList.innerHTML = successfulFiles.map(file => `
                    <div class="flex justify-between items-center">
                        <span class="truncate flex-1">📎 ${file.name}</span>
                        <a href="${file.url}" target="_blank" class="text-blue-600 hover:underline text-xs">Descargar</a>
                    </div>
                `).join('');
            } else {
                filesSection.style.display = 'none';
            }
            
            document.getElementById('ticketPopup').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            await sendEmail(ref, shirt, total);
        }

        async function sendEmail(ref, shirt, total) {
            const overlay = document.getElementById('sendingOverlay');
            const statusEl = document.getElementById('sendingStatus');
            
            overlay.classList.add('active');
            statusEl.textContent = 'Preparando cotización...';
            
            const posList = Object.entries(state.positions)
                .filter(([_, p]) => p.active)
                .map(([id, p]) => {
                    const cfg = config.positions.find(pos => pos.id === id);
                    const priceTable = config.printPrices[cfg.type];
                    return `${cfg.name} (${priceTable.name}): ${p.colors} tintas - $${priceTable.prices[p.colors]}/ud`;
                }).join('\n');
            
            const successfulFiles = state.uploadedFiles.filter(f => f.status === 'success');
            
            let filesListText = 'Ninguno';
            let filesLinksHtml = '';
            
            if (successfulFiles.length > 0) {
                filesListText = successfulFiles.map(f => 
                    `${f.name} (${f.format.toUpperCase()}, ${f.size})`
                ).join('\n');
                
                filesLinksHtml = successfulFiles.map(f => 
                    `<a href="${f.url}">${f.name}</a>`
                ).join('<br>');
            }
            
            statusEl.textContent = 'Enviando correo...';
            
            const emailData = {
                to_email: 'xsiempreverdex@gmail.com',
                from_name: state.client,
                reply_to: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                reference: ref,
                date: new Date().toLocaleString('es-MX'),
                shirt_type: shirt.name,
                shirt_price: shirt.price,
                quantity: state.quantity,
                positions: posList || 'Ninguna',
                extras: state.extras.map(id => config.extras.find(e => e.id === id).name).join(', ') || 'Ninguno',
                total: total,
                delivery: document.getElementById('deliveryTime').textContent,
                files_list: filesListText,
                files_links: filesLinksHtml,
                has_files: successfulFiles.length > 0 ? 'SÍ' : 'NO'
            };
            
            try {
                await emailjs.send("service_p52md8d", "template_qrlya7d", emailData);
                
                document.getElementById('ticketStamp').textContent = 'ENVIADO';
                document.getElementById('ticketStamp').style.color = '#00aa00';
                document.getElementById('ticketStamp').style.borderColor = '#00aa00';
                
                statusEl.textContent = '¡Enviado exitosamente!';
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('ticketStamp').textContent = 'ERROR';
                document.getElementById('ticketStamp').style.color = '#ff4444';
                statusEl.textContent = 'Error al enviar. Revisa la consola.';
            } finally {
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 1500);
            }
        }

        function closeTicketPopup() {
            document.getElementById('ticketPopup').classList.remove('active');
            document.body.style.overflow = '';
            
            setTimeout(() => {
                document.getElementById('ticketStamp').textContent = 'PENDIENTE';
                document.getElementById('ticketStamp').style.color = '#ff4444';
                document.getElementById('ticketStamp').style.borderColor = '#ff4444';
            }, 300);
        }

        function closeTicketIfOutside(event) {
            if (event.target === event.currentTarget) {
                closeTicketPopup();
            }
        }

        function printTicket() {
            window.print();
        }

        function shareQuote() {
            const total = document.getElementById('totalDisplay').textContent;
            const shirt = config.shirtTypes.find(s => s.id === state.shirtType).name;
            const posCount = Object.values(state.positions).filter(p => p.active).length;
            
            const text = `Calculadora AlquímicoLab. - Cotización\nCliente: ${state.client || 'N/A'}\n${state.quantity} ${shirt}\n${posCount} posición(es)\nTotal: ${total}`;
            
            if (navigator.share) {
                navigator.share({ title: 'Cotización Calculadora', text: text });
            } else {
                navigator.clipboard.writeText(text);
                alert('¡Copiado al portapapeles!');
            }
        }

        function resetForm() {
            state = {
                client: '',
                phone: '',
                email: '',
                shirtType: 'basic',
                quantity: 24,
                positions: {
                    front: { active: false, colors: 2 },
                    back: { active: false, colors: 1 },
                    leftChest: { active: false, colors: 1 },
                    rightChest: { active: false, colors: 1 },
                    leftSleeve: { active: false, colors: 1 },
                    rightSleeve: { active: false, colors: 1 }
                },
                extras: [],
                uploadedFiles: []
            };
            
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('quantity').value = 24;
            document.getElementById('quantityRange').value = 24;
            document.getElementById('minQtyWarning').classList.remove('show');
            
            updateFileList();
            init();
        }

        // Event listeners
        document.getElementById('clientName')?.addEventListener('input', updateClient);
        document.getElementById('clientPhone')?.addEventListener('input', validateForm);
        document.getElementById('clientEmail')?.addEventListener('input', validateForm);
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTicketPopup();
            }
        });
        
        document.getElementById('fileInput')?.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        init();
    </script>
</body>
</html>